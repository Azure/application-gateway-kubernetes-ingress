<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Multiple Namespace Support - Application Gateway Ingress Controller</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Multiple Namespace Support";
        var mkdocs_page_input_path = "features/multiple-namespaces.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/go.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Application Gateway Ingress Controller
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../annotations/">Annotations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../helm-values-documenation/">Helm Values Configuration Options</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../ingress-v1/">Ingress V1 Support</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Setup</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/install-existing/">Brownfield Deployment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/install-new-windows-cluster/">Preview - Greenfield Deployment (Windows Cluster)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/install-new/">Greenfield Deployment</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorials</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorial.e2e-ssl/">Tutorial: Setting up E2E SSL</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorial.general/">Tutorial: Basic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../agic-reconcile/">Agic reconcile</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../appgw-ssl-certificate/">Appgw ssl certificate</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cookie-affinity/">Cookie affinity</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../custom-ingress-class/">Custom Ingress Class</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Multiple Namespace Support</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#motivation">Motivation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#enable-multiple-namespace-support">Enable multiple namespace support</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#conflicting-configurations">Conflicting Configurations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#restricting-access-to-namespaces">Restricting Access to Namespaces</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../private-ip/">Using Private IP for internal routing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../probes/">Probes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">How tos</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../how-tos/continuous-deployment/">Continuous Deployment with AKS and AGIC using Azure Pipelines</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../how-tos/dns/">Automate DNS updates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../how-tos/helm-upgrade/">Upgrading AGIC using Helm</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../how-tos/lets-encrypt/">Certificate issuance with LetsEncrypt.org</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../how-tos/minimize-downtime-during-deployments/">Minimizing Downtime During Deployments</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../how-tos/networking/">How to setup networking between Application Gateway and AKS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../how-tos/scale-applications-using-appgw-metrics/">Scale your Applications using Application Gateway Metrics (Beta)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../how-tos/update-website/">Install MKDocs and plugins</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../how-tos/websockets/">Websockets</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequrently Asked Questions: [WIP]</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Troubleshootings</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/">Troubleshooting Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-addon-identity-not-found/">Troubleshooting agic addon identity not found</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-fails-with-aad-pod-identity-breakingchange/">Troubleshooting agic fails with aad pod identity breakingchange</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-pod-stuck-in-not-ready-state/">Troubleshooting agic pod stuck in not ready state</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-installing-a-simple-application/">Troubleshooting installing a simple application</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../logging-levels/">Logging Levels</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Developers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/build/">Building the controller</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/contribute/">Contribution Guidelines</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/design/">Application Gateway Ingress Controller Design (WIP)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/developer-guideline/">Application Gateway Ingress Controller Development Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/nightly/">Install the latest nightly build</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/test/">Testing the controller</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Application Gateway Ingress Controller</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Features &raquo;</li><li>Multiple Namespace Support</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/edit/master/docs/features/multiple-namespaces.md"> Edit on Azure/application-gateway-kubernetes-ingress</a>
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="multiple-namespace-support">Multiple Namespace Support</h1>
<h4 id="motivation">Motivation</h4>
<p>Kubernetes <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">Namespaces</a>
make it possible for a Kubernetes cluster to be partitioned and allocated to
sub-groups of a larger team. These sub-teams can then deploy and manage
infrastructure with finer controls of resources, security, configuration etc.
Kubernetes allows for one or more ingress resources to be defined independently
within each namespace.</p>
<p>As of version 0.7 <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/master/README.md">Azure Application Gateway Kubernetes
IngressController</a>
(AGIC) can ingest events from and observe multiple namespaces. Should the AKS
administrator decide to use <a href="https://azure.microsoft.com/en-us/services/application-gateway/">App
Gateway</a> as an
ingress, all namespaces will use the same instance of App Gateway. A single
installation of Ingress Controller will monitor accessible namespaces and will
configure the App Gateway it is associated with.</p>
<p>Version 0.7 of AGIC will continue to exclusively observe the <code>default</code>
namespace, unless this is explicitly changed to one or more different
namespaces in the Helm configuration (see section below).</p>
<h4 id="enable-multiple-namespace-support">Enable multiple namespace support</h4>
<p>To enable multiple namespace support:
1. modify the <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a> file in one of the following ways:
   - delete the <code>watchNamespace</code> key entirely from <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a> - AGIC will observe all namespaces
   - set <code>watchNamespace</code> to an empty string - AGIC will observe all namespaces
   - add multiple namespaces separated by a comma (<code>watchNamespace: default,secondNamespace</code>) - AGIC will observe these namespaces exclusively
2. apply  Helm template changes with: <code>helm install -f helm-config.yaml application-gateway-kubernetes-ingress/ingress-azure</code></p>
<p>Once deployed with the ability to observe multiple namespaces, AGIC will:
  - list ingress resources from all accessible namespaces
  - filter to ingress resources annotated with <code>kubernetes.io/ingress.class: azure/application-gateway</code>
  - compose combined <a href="https://github.com/Azure/azure-sdk-for-go/blob/37f3f4162dfce955ef5225ead57216cf8c1b2c70/services/network/mgmt/2016-06-01/network/models.go#L1710-L1744">App Gateway config</a>
  - apply the config to the associated App Gateway via <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview">ARM</a></p>
<h4 id="conflicting-configurations">Conflicting Configurations</h4>
<p>Multiple namespaced <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#the-ingress-resource">ingress resources</a>
could instruct AGIC to create conflicting configurations for a single App Gateway. (Two ingresses claiming the same
domain for instance.)</p>
<p>At the top of the hierarchy - <strong>listeners</strong> (IP address, port, and host) and <strong>routing rules</strong> (binding listener,
backend pool and HTTP settings) could be created and shared by multiple namespaces/ingresses.</p>
<p>On the other hand - paths, backend pools, HTTP settings, and TLS certificates could be created by one namespace only
and duplicates will removed..</p>
<p>For example, consider the following duplicate ingress resources defined
namespaces <code>staging</code> and <code>production</code> for <code>www.contoso.com</code>:
<div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">websocket-ingress</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">staging</span>
  <span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">rules</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">www.contoso.com</span>
      <span class="nt">http</span><span class="p">:</span>
        <span class="nt">paths</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">backend</span><span class="p">:</span>
              <span class="nt">service</span><span class="p">:</span>
                <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web-service</span>
                <span class="nt">port</span><span class="p">:</span>
                  <span class="nt">number</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div></p>
<div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">websocket-ingress</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">production</span>
  <span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">rules</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">www.contoso.com</span>
      <span class="nt">http</span><span class="p">:</span>
        <span class="nt">paths</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">backend</span><span class="p">:</span>
              <span class="nt">service</span><span class="p">:</span>
                <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web-service</span>
                <span class="nt">port</span><span class="p">:</span>
                  <span class="nt">number</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div>
<p>Despite the two ingress resources demanding traffic for <code>www.contoso.com</code> to be
routed to the respective Kubernetes namespaces, only one backend can service
the traffic. AGIC would create a configuration on "first come, first served"
basis for one of the resources. If two ingresses resources are created at the
same time, the one earlier in the alphabet will take
precedence. From the example above we will only be able to create settings for
the <code>production</code> ingress. App Gateway will be configured with the following
resources:</p>
<ul>
<li>Listener: <code>fl-www.contoso.com-80</code></li>
<li>Routing Rule: <code>rr-www.contoso.com-80</code></li>
<li>Backend Pool: <code>pool-production-contoso-web-service-80-bp-80</code></li>
<li>HTTP Settings: <code>bp-production-contoso-web-service-80-80-websocket-ingress</code></li>
<li>Health Probe: <code>pb-production-contoso-web-service-80-websocket-ingress</code></li>
</ul>
<p>Note that except for <em>listener</em> and <em>routing rule</em>, the App Gateway resources created include the name
of the namespace (<code>production</code>) for which they were created.</p>
<p>If the two ingress resources are introduced into the AKS cluster at different
points in time, it is likely for AGIC to end up in a scenario where it
reconfigures App Gateway and re-routes traffic from <code>namespace-B</code> to
<code>namespace-A</code>.</p>
<p>For example if you added <code>staging</code> first, AGIC will configure App Gwy to route
traffic to the staging backend pool. At a later stage, introducing <code>production</code>
ingress, will cause AGIC to reprogram App Gwy, which will start routing traffic
to the <code>production</code> backend pool.</p>
<h4 id="restricting-access-to-namespaces">Restricting Access to Namespaces</h4>
<p>By default AGIC will configure App Gateway based on annotated Ingress within
any namespace. Should you want to limit this behaviour you have the following
options:
  - limit the namespaces, by explicitly defining namespaces AGIC should observe via the <code>watchNamespace</code> YAML key in <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a>
  - use <a href="https://docs.microsoft.com/en-us/azure/aks/azure-ad-rbac">Role/RoleBinding</a> to limit AGIC to specific namespaces</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../custom-ingress-class/" class="btn btn-neutral float-left" title="Custom Ingress Class"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../private-ip/" class="btn btn-neutral float-right" title="Using Private IP for internal routing">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../custom-ingress-class/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../private-ip/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
