<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Multiple Namespace Support - Application Gateway Ingress Controller</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../../css/extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Multiple Namespace Support";
    var mkdocs_page_input_path = "features/multiple-namespaces.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Application Gateway Ingress Controller</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Setup</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../setup/install-existing/">Brownfield Deployment</a>
                </li>
                <li class="">
                    
    <a class="" href="../../setup/install-new/">Greenfield Deployment</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../tutorial/">Tutorials</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../annotations/">Annotations</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Features</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../cookie-affinity/">Cookie affinity</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Multiple Namespace Support</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#multiple-namespace-support">Multiple Namespace Support</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#motivation">Motivation</a></li>
        
            <li><a class="toctree-l4" href="#enable-multiple-namespace-support">Enable multiple namespace support</a></li>
        
            <li><a class="toctree-l4" href="#conflicting-configurations">Conflicting Configurations</a></li>
        
            <li><a class="toctree-l4" href="#restricting-access-to-namespaces">Restricting Access to Namespaces</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../private-ip/">Using Private IP for internal routing</a>
                </li>
                <li class="">
                    
    <a class="" href="../probes/">Probes</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">How tos</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../how-tos/helm-upgrade/">Upgrading AGIC using Helm</a>
                </li>
                <li class="">
                    
    <a class="" href="../../how-tos/lets-encrypt/">Certificate issuance with LetsEncrypt.org</a>
                </li>
                <li class="">
                    
    <a class="" href="../../how-tos/websockets/">Websockets</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../faq/">Frequrently Asked Questions: [WIP]</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../troubleshooting/">Troubleshooting</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Developers</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../developers/build/">Building the controller</a>
                </li>
                <li class="">
                    
    <a class="" href="../../developers/contribute/">Contribution Guidelines</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Application Gateway Ingress Controller</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Features &raquo;</li>
        
      
    
    <li>Multiple Namespace Support</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/edit/master/docs/features/multiple-namespaces.md"> Edit on Azure/application-gateway-kubernetes-ingress</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="multiple-namespace-support">Multiple Namespace Support</h1>
<h4 id="motivation">Motivation</h4>
<p>Kubernetes <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">Namespaces</a>
make it possible for a Kubernetes cluster to be partitioned and allocated to
sub-groups of a larger team. These sub-teams can then deploy and manage
infrastructure with finer controls of resources, security, configuration etc.
Kubernetes allows for one or more ingress resources to be defined independently
within each namespace.</p>
<p>As of version 0.7 <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/master/README.md">Azure Application Gateway Kubernetes
IngressController</a>
(AGIC) can ingest events from and observe multiple namespaces. Should the AKS
administrator decide to use <a href="https://azure.microsoft.com/en-us/services/application-gateway/">App
Gateway</a> as an
ingress, all namespaces will use the same instance of App Gateway. A single
installation of Ingress Controller will monitor accessible namespaces and will
configure the App Gateway it is associated with.</p>
<p>Version 0.7 of AGIC will continue to exclusively observe the <code>default</code>
namespace, unless this is explicitly changed to one or more different
namespaces in the Helm configuration (see section below).</p>
<h4 id="enable-multiple-namespace-support">Enable multiple namespace support</h4>
<p>To enable multiple namespace support:
1. modify the <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a> file in one of the following ways:
   - delete the <code>watchNamespace</code> key entirely from <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a> - AGIC will observe all namespaces
   - set <code>watchNamespace</code> to an empty string - AGIC will observe all namespaces
   - add multiple namespaces separated by a comma (<code>watchNamespace: default,secondNamespace</code>) - AGIC will observe these namespaces exclusively
2. apply  Helm template changes with: <code>helm install -f helm-config.yaml application-gateway-kubernetes-ingress/ingress-azure</code></p>
<p>Once deployed with the ability to observe multiple namespaces, AGIC will:
  - list ingress resources from all accessible namespaces
  - filter to ingress resources annotated with <code>kubernetes.io/ingress.class: azure/application-gateway</code>
  - compose combined <a href="https://github.com/Azure/azure-sdk-for-go/blob/37f3f4162dfce955ef5225ead57216cf8c1b2c70/services/network/mgmt/2016-06-01/network/models.go#L1710-L1744">App Gateway config</a>
  - apply the config to the associated App Gateway via <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview">ARM</a></p>
<h4 id="conflicting-configurations">Conflicting Configurations</h4>
<p>Multiple namespaced <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#the-ingress-resource">ingress resources</a>
could instruct AGIC to create conflicting configurations for a single App Gateway. (Two ingresses claiming the same
domain for instance.)</p>
<p>At the top of the hierarchy - <strong>listeners</strong> (IP address, port, and host) and <strong>routing rules</strong> (binding listener,
backend pool and HTTP settings) could be created and shared by multiple namespaces/ingresses.</p>
<p>On the other hand - paths, backend pools, HTTP settings, and TLS certificates could be created by one namespace only
and duplicates will removed..</p>
<p>For example, consider the following duplicate ingress resources defined
namespaces <code>staging</code> and <code>production</code> for <code>www.contoso.com</code>:
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">websocket-ingress</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">staging</span>
  <span class="l l-Scalar l-Scalar-Plain">annotations</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">kubernetes.io/ingress.class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">rules</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">www.contoso.com</span>
      <span class="l l-Scalar l-Scalar-Plain">http</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">backend</span><span class="p p-Indicator">:</span>
              <span class="l l-Scalar l-Scalar-Plain">serviceName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web-service</span>
              <span class="l l-Scalar l-Scalar-Plain">servicePort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div></p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">websocket-ingress</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">production</span>
  <span class="l l-Scalar l-Scalar-Plain">annotations</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">kubernetes.io/ingress.class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">rules</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">www.contoso.com</span>
      <span class="l l-Scalar l-Scalar-Plain">http</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">backend</span><span class="p p-Indicator">:</span>
              <span class="l l-Scalar l-Scalar-Plain">serviceName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web-service</span>
              <span class="l l-Scalar l-Scalar-Plain">servicePort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div>

<p>Despite the two ingress resources demanding traffic for <code>www.contoso.com</code> to be
routed to the respective Kubernetes namespaces, only one backend can service
the traffic. AGIC would create a configuration on "first come, first served"
basis for one of the resources. If two ingresses resources are created at the
same time, the one earlier in the alphabet will take
precedence. From the example above we will only be able to create settings for
the <code>production</code> ingress. App Gateway will be configured with the following
resources:</p>
<ul>
<li>Listener: <code>fl-www.contoso.com-80</code></li>
<li>Routing Rule: <code>rr-www.contoso.com-80</code></li>
<li>Backend Pool: <code>pool-production-contoso-web-service-80-bp-80</code></li>
<li>HTTP Settings: <code>bp-production-contoso-web-service-80-80-websocket-ingress</code></li>
<li>Health Probe: <code>pb-production-contoso-web-service-80-websocket-ingress</code></li>
</ul>
<p>Note that except for <em>listener</em> and <em>routing rule</em>, the App Gateway resources created include the name
of the namespace (<code>production</code>) for which they were created.</p>
<p>If the two ingress resources are introduced into the AKS cluster at different
points in time, it is likely for AGIC to end up in a scenario where it
reconfigures App Gateway and re-routes traffic from <code>namespace-B</code> to
<code>namespace-A</code>.</p>
<p>For example if you added <code>staging</code> first, AGIC will configure App Gwy to route
traffic to the staging backend pool. At a later stage, introducing <code>production</code>
ingress, will cause AGIC to reprogram App Gwy, which will start routing traffic
to the <code>production</code> backend pool.</p>
<h4 id="restricting-access-to-namespaces">Restricting Access to Namespaces</h4>
<p>By default AGIC will configure App Gateway based on annotated Ingress within
any namespace. Should you want to limit this behaviour you have the following
options:
  - limit the namespaces, by explicitly defining namespaces AGIC should observe via the <code>watchNamespace</code> YAML key in <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a>
  - use <a href="https://docs.microsoft.com/en-us/azure/aks/azure-ad-rbac">Role/RoleBinding</a> to limit AGIC to specific namespaces</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../private-ip/" class="btn btn-neutral float-right" title="Using Private IP for internal routing">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../cookie-affinity/" class="btn btn-neutral" title="Cookie affinity"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../cookie-affinity/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../private-ip/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
