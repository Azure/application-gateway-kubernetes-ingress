<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Certificate issuance with LetsEncrypt.org - Application Gateway Ingress Controller</title>
  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../docs/css/extra.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Certificate issuance with LetsEncrypt.org";
    var mkdocs_page_input_path = "how-tos/lets-encrypt.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Application Gateway Ingress Controller</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../annotations/">Annotations</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../helm-values-documenation/">Helm Values Configuration Options</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../ingress-v1/">Ingress V1 Support</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../setup/install/">Install</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorial.e2e-ssl/">Tutorial: Setting up E2E SSL</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorial.general/">Tutorial: Basic</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Features</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/agic-reconcile/">Agic reconcile</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/appgw-ssl-certificate/">Appgw ssl certificate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/cookie-affinity/">Cookie affinity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/custom-ingress-class/">Custom Ingress Class</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/multiple-namespaces/">Multiple Namespace Support</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/private-ip/">Using Private IP for internal routing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/probes/">Probes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/rewrite-rule-set-custom-resource/">Rewrite rule set custom resource</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">How tos</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../continuous-deployment/">Continuous Deployment with AKS and AGIC using Azure Pipelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../deploy-AGIC-with-Workload-Identity-using-helm/">How to deploy AGIC via Helm using Workload Identity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dns/">Automate DNS updates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../helm-upgrade/">Upgrading AGIC using Helm</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Certificate issuance with LetsEncrypt.org</a>
    <ul class="current">
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../minimize-downtime-during-deployments/">Minimizing Downtime During Deployments</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../networking/">How to setup networking between Application Gateway and AKS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../prevent-agic-from-overwriting/">Preventing AGIC from removing certain rules</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../scale-applications-using-appgw-metrics/">Scale your Applications using Application Gateway Metrics (Beta)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../websockets/">Websockets</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequrently Asked Questions: [WIP]</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Troubleshootings</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/">Troubleshooting Guide</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-addon-identity-not-found/">Troubleshooting agic addon identity not found</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-fails-with-aad-pod-identity-breakingchange/">Troubleshooting agic fails with aad pod identity breakingchange</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-pod-stuck-in-not-ready-state/">Troubleshooting agic pod stuck in not ready state</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-installing-a-simple-application/">Troubleshooting installing a simple application</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../logging-levels/">Logging Levels</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Developers</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/build/">Building the controller</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/contribute/">Contribution Guidelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/design/">Application Gateway Ingress Controller Design (WIP)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/developer-guideline/">Application Gateway Ingress Controller Development Guide</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/nightly/">Install the latest nightly build</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/test/">Testing the controller</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Application Gateway Ingress Controller</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>How tos &raquo;</li>
        
      
    
    <li>Certificate issuance with LetsEncrypt.org</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/edit/master/docs/how-tos/lets-encrypt.md"> Edit on Azure/application-gateway-kubernetes-ingress</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="certificate-issuance-with-letsencryptorg">Certificate issuance with LetsEncrypt.org</h1>
<blockquote>
<p><strong><em>NOTE:</em></strong> <a href="https://aka.ms/agc">Application Gateway for Containers</a> has been released, which introduces numerous performance, resilience, and feature changes. Please consider leveraging Application Gateway for Containers for your next deployment.</p>
</blockquote>
<p>This section configures your AKS to leverage <a href="https://letsencrypt.org/">LetsEncrypt.org</a> and automatically obtain a
TLS/SSL certificate for your domain. The certificate will be installed on Application Gateway, which will perform
SSL/TLS termination for your AKS cluster. The setup described here uses the
<a href="https://github.com/jetstack/cert-manager">cert-manager</a> Kubernetes add-on, which automates the creation and management of certificates.</p>
<p>Follow the steps below to install <a href="https://docs.cert-manager.io">cert-manager</a> on your existing AKS cluster.</p>
<ol>
<li>
<p>Helm Chart</p>
<p>Run the following script to install the <code>cert-manager</code> helm chart. This will:</p>
<ul>
<li>create a new <code>cert-manager</code> namespace on your AKS</li>
<li>create the following CRDs: Certificate, Challenge, ClusterIssuer, Issuer, Order</li>
<li>install cert-manager chart (from <a href="https://docs.cert-manager.io/en/latest/getting-started/install/kubernetes.html#steps">docs.cert-manager.io)</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Install the CustomResourceDefinition resources separately</span>
<span class="c1"># Note: --validate=false is required per https://github.com/jetstack/cert-manager/issues/2208#issuecomment-541311021</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/jetstack/cert-manager/release-0.13/deploy/manifests/00-crds.yaml<span class="w"> </span>--validate<span class="o">=</span><span class="nb">false</span>

<span class="c1"># Create the namespace for cert-manager</span>
kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>cert-manager

<span class="c1"># Label the cert-manager namespace to disable resource validation</span>
kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>cert-manager<span class="w"> </span>cert-manager.io/disable-validation<span class="o">=</span><span class="nb">true</span>

<span class="c1"># Add the Jetstack Helm repository</span>
helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>jetstack<span class="w"> </span>https://charts.jetstack.io

<span class="c1"># Update your local Helm chart repository cache</span>
helm<span class="w"> </span>repo<span class="w"> </span>update

<span class="c1"># Install v0.11 of cert-manager Helm chart</span>
helm<span class="w"> </span>install<span class="w"> </span>cert-manager<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--namespace<span class="w"> </span>cert-manager<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--version<span class="w"> </span>v0.13.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>jetstack/cert-manager
</code></pre></div>
</li>
<li>
<p>ClusterIssuer Resource</p>
<p>Create a <code>ClusterIssuer</code> resource. It is required by <code>cert-manager</code> to represent the <code>Lets Encrypt</code> certificate
authority where the signed certificates will be obtained.</p>
<p>By using the non-namespaced <code>ClusterIssuer</code> resource, cert-manager will issue certificates that can be consumed from
multiple namespaces. <code>Let’s Encrypt</code> uses the ACME protocol to verify that you control a given domain name and to issue
you a certificate. More details on configuring <code>ClusterIssuer</code> properties
<a href="https://docs.cert-manager.io/en/latest/tasks/issuers/index.html">here</a>. <code>ClusterIssuer</code> will instruct <code>cert-manager</code>
to issue certificates using the <code>Lets Encrypt</code> staging environment used for testing (the root certificate not present
in browser/client trust stores).</p>
<p>The default challenge type in the YAML below is <code>http01</code>. Other challenges are documented on <a href="https://letsencrypt.org/docs/challenge-types/">letsencrypt.org - Challenge Types</a></p>
<p><strong>IMPORTANT:</strong> Update <code>&lt;YOUR.EMAIL@ADDRESS&gt;</code> in the YAML below</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: cert-manager.io/v1alpha2</span>
<span class="s">kind: ClusterIssuer</span>
<span class="s">metadata:</span>
<span class="s">  name: letsencrypt-staging</span>
<span class="s">spec:</span>
<span class="s">  acme:</span>

<span class="s">    # You must replace this email address with your own.</span>
<span class="s">    # Let&#39;s Encrypt will use this to contact you about expiring</span>
<span class="s">    # certificates, and issues related to your account.</span>
<span class="s">    email: &lt;YOUR.EMAIL@ADDRESS&gt;</span>

<span class="s">    # ACME server URL for Let’s Encrypt’s staging environment.</span>
<span class="s">    # The staging environment will not issue trusted certificates but is</span>
<span class="s">    # used to ensure that the verification process is working properly</span>
<span class="s">    # before moving to production</span>
<span class="s">    server: https://acme-staging-v02.api.letsencrypt.org/directory</span>

<span class="s">    privateKeySecretRef:</span>
<span class="s">      # Secret resource used to store the account&#39;s private key.</span>
<span class="s">      name: letsencrypt-secret</span>

<span class="s">    # Enable the HTTP-01 challenge provider</span>
<span class="s">    # you prove ownership of a domain by ensuring that a particular</span>
<span class="s">    # file is present at the domain</span>
<span class="s">    solvers:</span>
<span class="s">    - http01:</span>
<span class="s">        ingress:</span>
<span class="s">            class: azure/application-gateway</span>
<span class="s">EOF</span>
</code></pre></div>
</li>
<li>
<p>Deploy App</p>
<p>Create an Ingress resource to Expose the <code>guestbook</code> application using the Application Gateway with the Lets Encrypt Certificate.</p>
<p>Ensure you Application Gateway has a public Frontend IP configuration with a DNS name (either using the
default <code>azure.com</code> domain, or provision a <code>Azure DNS Zone</code> service, and assign your own custom domain).
Note the annotation <code>cert-manager.io/cluster-issuer: letsencrypt-staging</code>, which tells cert-manager to process the
tagged Ingress resource.</p>
<p><strong>IMPORTANT:</strong>  Update <code>&lt;PLACEHOLDERS.COM&gt;</code> in the YAML below with your own domain (or the Application Gateway one, for example
'kh-aks-ingress.westeurope.cloudapp.azure.com')</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: networking.k8s.io/v1</span>
<span class="s">kind: Ingress</span>
<span class="s">metadata:</span>
<span class="s">name: guestbook-letsencrypt-staging</span>
<span class="s">annotations:</span>
<span class="s">    kubernetes.io/ingress.class: azure/application-gateway</span>
<span class="s">    cert-manager.io/cluster-issuer: letsencrypt-staging</span>
<span class="s">    cert-manager.io/acme-challenge-type: http01</span>
<span class="s">spec:</span>
<span class="s">tls:</span>
<span class="s">- hosts:</span>
<span class="s">    - &lt;PLACEHOLDERS.COM&gt;</span>
<span class="s">    secretName: guestbook-secret-name</span>
<span class="s">rules:</span>
<span class="s">- host: &lt;PLACEHOLDERS.COM&gt;</span>
<span class="s">    http:</span>
<span class="s">    paths:</span>
<span class="s">    - backend:</span>
<span class="s">        service:</span>
<span class="s">            name: frontend</span>
<span class="s">            port:</span>
<span class="s">                number: 80</span>
<span class="s">EOF</span>
</code></pre></div>
<p>Use <code>kubectl describe clusterissuer letsencrypt-staging</code> to view the state of status of the ACME account registration.
Use <code>kubectl get secret guestbook-secret-name -o yaml</code> to view the certificate issued.</p>
<p>After a few seconds, you  can access the <code>guestbook</code> service through the Application Gateway HTTPS url using the automatically issued <strong>staging</strong> <code>Lets Encrypt</code> certificate.
Your browser may warn you of an invalid cert authority. The staging certificate is issued by <code>CN=Fake LE Intermediate X1</code>. This is an indication that the system worked as expected and you are ready for your production certificate.</p>
</li>
<li>
<p>Production Certificate
    Once your staging certificate is setup successfully you can switch to a production ACME server:</p>
<ol>
<li>Replace the staging annotation on your Ingress resource with: <code>cert-manager.io/cluster-issuer: letsencrypt-prod</code></li>
<li>Delete the existing staging <code>ClusterIssuer</code> you created in the previous step and create a new one by replacing the ACME server from the ClusterIssuer YAML above with <code>https://acme-v02.api.letsencrypt.org/directory</code></li>
</ol>
</li>
<li>
<p>Certificate Expiration and Renewal
    Before the <code>Lets Encrypt</code> certificate expires, <code>cert-manager</code> will automatically update the certificate in the Kubernetes secret store. At that point, Application Gateway Ingress Controller will apply the updated secret referenced in the ingress resources it is using to configure the Application Gateway.</p>
</li>
</ol>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../minimize-downtime-during-deployments/" class="btn btn-neutral float-right" title="Minimizing Downtime During Deployments">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../helm-upgrade/" class="btn btn-neutral" title="Upgrading AGIC using Helm"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../helm-upgrade/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../minimize-downtime-during-deployments/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
