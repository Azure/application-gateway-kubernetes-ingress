<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Preventing AGIC from removing certain rules - Application Gateway Ingress Controller</title>
  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../css/extra.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Preventing AGIC from removing certain rules";
    var mkdocs_page_input_path = "how-tos/prevent-agic-from-overwriting.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Application Gateway Ingress Controller</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../annotations/">Annotations</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../helm-values-documenation/">Helm Values Configuration Options</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../ingress-v1/">Ingress V1 Support</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../setup/install/">Install</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorial.e2e-ssl/">Tutorial: Setting up E2E SSL</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorial.general/">Tutorial: Basic</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Features</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/agic-reconcile/">Agic reconcile</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/appgw-ssl-certificate/">Appgw ssl certificate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/cookie-affinity/">Cookie affinity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/custom-ingress-class/">Custom Ingress Class</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/multiple-namespaces/">Multiple Namespace Support</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/private-ip/">Using Private IP for internal routing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/probes/">Probes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/rewrite-rule-set-custom-resource/">Rewrite rule set custom resource</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">How tos</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../continuous-deployment/">Continuous Deployment with AKS and AGIC using Azure Pipelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../deploy-AGIC-with-Workload-Identity-using-helm/">How to deploy AGIC via Helm using Workload Identity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dns/">Automate DNS updates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../helm-upgrade/">Upgrading AGIC using Helm</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../lets-encrypt/">Certificate issuance with LetsEncrypt.org</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../minimize-downtime-during-deployments/">Minimizing Downtime During Deployments</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../networking/">How to setup networking between Application Gateway and AKS</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Preventing AGIC from removing certain rules</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#example-scenario">Example Scenario</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#enable-with-new-agic-installation">Enable with new AGIC installation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#broaden-permissions">Broaden permissions</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#enable-for-an-existing-agic-installation">Enable for an existing AGIC installation</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../scale-applications-using-appgw-metrics/">Scale your Applications using Application Gateway Metrics (Beta)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../websockets/">Websockets</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequrently Asked Questions: [WIP]</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Troubleshootings</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/">Troubleshooting Guide</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-addon-identity-not-found/">Troubleshooting agic addon identity not found</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-fails-with-aad-pod-identity-breakingchange/">Troubleshooting agic fails with aad pod identity breakingchange</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-pod-stuck-in-not-ready-state/">Troubleshooting agic pod stuck in not ready state</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-installing-a-simple-application/">Troubleshooting installing a simple application</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../logging-levels/">Logging Levels</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Developers</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/build/">Building the controller</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/contribute/">Contribution Guidelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/design/">Application Gateway Ingress Controller Design (WIP)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/developer-guideline/">Application Gateway Ingress Controller Development Guide</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/nightly/">Install the latest nightly build</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/test/">Testing the controller</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Application Gateway Ingress Controller</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>How tos &raquo;</li>
        
      
    
    <li>Preventing AGIC from removing certain rules</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/edit/master/docs/how-tos/prevent-agic-from-overwriting.md"> Edit on Azure/application-gateway-kubernetes-ingress</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="preventing-agic-from-removing-certain-rules">Preventing AGIC from removing certain rules</h1>
<blockquote>
<p><strong><em>NOTE:</em></strong> <a href="https://aka.ms/agc">Application Gateway for Containers</a> has been released, which introduces numerous performance, resilience, and feature changes. Please consider leveraging Application Gateway for Containers for your next deployment.</p>
<p>Note: This feature is <strong>EXPERIMENTAL</strong> with <strong>limited support</strong>. Use with caution.</p>
</blockquote>
<p>By default AGIC assumes full ownership of the App Gateway it is linked to. AGIC version 0.8.0 and later allows
retaining rules to allow adding VMSS as backend along with AKS cluster.</p>
<p>Please <strong>backup your App Gateway's configuration</strong> before enabling this setting:</p>
<ol>
<li>using <a href="https://portal.azure.com/">Azure Portal</a> navigate to your <code>App Gateway</code> instance</li>
<li>from <code>Export template</code> click <code>Download</code></li>
</ol>
<p>The zip file you downloaded will have JSON templates, bash, and PowerShell scripts you could use to restore App Gateway</p>
<h2 id="example-scenario">Example Scenario</h2>
<p>Let's look at an imaginary App Gateway, which manages traffic for 2 web sites:</p>
<ul>
<li><code>dev.contoso.com</code> - hosted on a new AKS, using App Gateway and AGIC</li>
<li><code>prod.contoso.com</code> - hosted on an <a href="https://azure.microsoft.com/en-us/services/virtual-machine-scale-sets/">Azure VMSS</a></li>
</ul>
<p>With default settings, AGIC assumes 100% ownership of the App Gateway it is pointed to. AGIC overwrites all of App
Gateway's configuration. If we were to manually create a listener for <code>prod.contoso.com</code> (on App Gateway), without
defining it in the Kubernetes Ingress, AGIC will delete the <code>prod.contoso.com</code> config within seconds.</p>
<p>To install AGIC and also serve <code>prod.contoso.com</code> from our VMSS machines, we must constrain AGIC to configuring
<code>dev.contoso.com</code> only. This is facilitated by instantiating the following
<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRD</a>:</p>
<p><code>bash
cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: "appgw.ingress.k8s.io/v1"
kind: AzureIngressProhibitedTarget
metadata:
  name: prod-contoso-com
spec:
  hostname: prod.contoso.com
EOF</code></p>
<p>The command above creates an <code>AzureIngressProhibitedTarget</code> object. This makes AGIC (version 0.8.0 and later) aware of the existence of
App Gateway config for <code>prod.contoso.com</code> and explicitly instructs it to avoid changing any configuration
related to that hostname.</p>
<h2 id="enable-with-new-agic-installation">Enable with new AGIC installation</h2>
<p>To limit AGIC (version 0.8.0 and later) to a subset of the App Gateway configuration modify the <code>helm-config.yaml</code> template.
Under the <code>appgw:</code> section, add <code>shared</code> key and set it to to <code>true</code>.</p>
<p><code>yaml
appgw:
    subscriptionId: &lt;subscriptionId&gt;    # existing field
    resourceGroup: &lt;resourceGroupName&gt;  # existing field
    name: &lt;applicationGatewayName&gt;      # existing field
    shared: true                        # &lt;&lt;&lt;&lt;&lt; Add this field to enable shared App Gateway &gt;&gt;&gt;&gt;&gt;</code></p>
<p>Apply the Helm changes:</p>
<ol>
<li>
<p>Ensure the <code>AzureIngressProhibitedTarget</code> CRD is installed with:</p>
<p><code>bash
  kubectl apply -f https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/ae695ef9bd05c8b708cedf6ff545595d0b7022dc/crds/AzureIngressProhibitedTarget.yaml</code></p>
</li>
<li>
<p>Update Helm:</p>
<p><code>bash
  helm upgrade \
      --recreate-pods \
      -f helm-config.yaml \
      ingress-azure oci://mcr.microsoft.com/azure-application-gateway/charts/ingress-azure</code></p>
</li>
</ol>
<p>As a result your AKS will have a new instance of <code>AzureIngressProhibitedTarget</code> called <code>prohibit-all-targets</code>:</p>
<p><code>bash
kubectl get AzureIngressProhibitedTargets prohibit-all-targets -o yaml</code></p>
<p>The object <code>prohibit-all-targets</code>, as the name implies, prohibits AGIC from changing config for <em>any</em> host and path.
Helm install with <code>appgw.shared=true</code> will deploy AGIC, but will not make any changes to App Gateway.</p>
<h2 id="broaden-permissions">Broaden permissions</h2>
<p>Since Helm with <code>appgw.shared=true</code> and the default <code>prohibit-all-targets</code> blocks AGIC from applying any config.</p>
<p>Broaden AGIC permissions with:</p>
<ol>
<li>
<p>Create a new <code>AzureIngressProhibitedTarget</code> with your specific setup:</p>
<p><code>bash
cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: "appgw.ingress.k8s.io/v1"
kind: AzureIngressProhibitedTarget
metadata:
  name: your-custom-prohibitions
spec:
  hostname: your.own-hostname.com
EOF</code></p>
</li>
</ol>
<p><strong>NOTE:</strong> To prohibit AGIC from making changes, in addition to <em>hostname</em>, a list of URL paths can also be configured as part of your prohibited policy, please refer to the <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/master/crds/AzureIngressProhibitedTarget-v1-CRD-v1.yaml">schema</a> for details.</p>
<ol>
<li>
<p>Only after you have created your own custom prohibition, you can delete the default one, which is too broad:</p>
<p><code>bash
kubectl delete AzureIngressProhibitedTarget prohibit-all-targets</code></p>
</li>
</ol>
<h2 id="enable-for-an-existing-agic-installation">Enable for an existing AGIC installation</h2>
<p>Let's assume that we already have a working AKS, App Gateway, and configured AGIC in our cluster. We have an Ingress for
<code>prod.contosor.com</code> and are successfully serving traffic for it from AKS. We want to add <code>staging.contoso.com</code> to our
existing App Gateway, but need to host it on a <a href="https://azure.microsoft.com/en-us/services/virtual-machines/">VM</a>. We
are going to re-use the existing App Gateway and manually configure a listener and backend pools for
<code>staging.contoso.com</code>. But manually tweaking App Gateway config (via
<a href="https://portal.azure.com">portal</a>, <a href="https://docs.microsoft.com/en-us/rest/api/resources/">ARM APIs</a> or
<a href="https://www.terraform.io/">Terraform</a>) would conflict with AGIC's assumptions of full ownership. Shortly after we apply
changes, AGIC will overwrite or delete them.</p>
<p>We can prohibit AGIC from making changes to a subset of configuration.</p>
<ol>
<li>
<p>Create an <code>AzureIngressProhibitedTarget</code> object:</p>
<p><code>bash
cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: "appgw.ingress.k8s.io/v1"
kind: AzureIngressProhibitedTarget
metadata:
  name: manually-configured-staging-environment
spec:
  hostname: staging.contoso.com
EOF</code></p>
</li>
<li>
<p>View the newly created object:</p>
<p><code>bash
kubectl get AzureIngressProhibitedTargets</code></p>
</li>
<li>
<p>Modify App Gateway config via portal - add listeners, routing rules, backends etc. The new object we created
(<code>manually-configured-staging-environment</code>) will prohibit AGIC from overwriting App Gateway configuration related to
<code>staging.contoso.com</code>.</p>
</li>
</ol>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../scale-applications-using-appgw-metrics/" class="btn btn-neutral float-right" title="Scale your Applications using Application Gateway Metrics (Beta)">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../networking/" class="btn btn-neutral" title="How to setup networking between Application Gateway and AKS"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../networking/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../scale-applications-using-appgw-metrics/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
