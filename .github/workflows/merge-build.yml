name: "Merge Build"

on:
  push:
    branches:
      - master
      - release/*
  pull_request:
    branches:
      - master
      - release/*
permissions:
  actions: read
  contents: read
  deployments: read
  pull-requests: write  # Required to comment on PRs

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Go workspace
        run: |
          shopt -s extglob
          shopt -s dotglob
        shell: bash
      - name: Install Helm
        uses: azure/setup-helm@v4.2.0
        with:
          version: v3.11.0
      - name: Set up Go
        uses: actions/setup-go@v5.0.1
        with:
          go-version: '1.23.6'
      - name: Go and Helm lint check
        run: make lint-all
      - name: Go vet
        run: make vet-all
      - name: Get dependencies and build
        run: make build
      - name: Run unit tests with code coverage
        run: make unittest > coverage.txt
      - name: Publish test results
        if: always()
        uses: actions/upload-artifact@v4.3.3
        with:
          name: test-results
          path: ${{ github.workspace }}/**/report.xml
      - name: Publish code coverage results
        if: always()
        uses: actions/upload-artifact@v4.3.3
        with:
          name: code-coverage
          path: coverage.txt
      - name: Add Coverage Summary to GitHub Checks
        run: |
          echo "### Code Coverage Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          tail -n 10 coverage.txt >> $GITHUB_STEP_SUMMARY
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'coverage.txt';
            if (fs.existsSync(path)) {
              const coverage = fs.readFileSync(path, 'utf8').split('\n').slice(-5).join('\n');
              const comment = `### ðŸ“Š Code Coverage Report\n\`\`\`\n${coverage}\n\`\`\``;
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
