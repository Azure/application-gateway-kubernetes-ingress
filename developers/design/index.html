<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Application Gateway Ingress Controller Design (WIP) - Application Gateway Ingress Controller</title>
  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../css/extra.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Application Gateway Ingress Controller Design (WIP)";
    var mkdocs_page_input_path = "developers/design.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Application Gateway Ingress Controller</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../annotations/">Annotations</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../helm-values-documenation/">Helm Values Configuration Options</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../ingress-v1/">Ingress V1 Support</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../setup/install/">Install</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorial.e2e-ssl/">Tutorial: Setting up E2E SSL</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorial.general/">Tutorial: Basic</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Features</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/agic-reconcile/">Agic reconcile</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/appgw-ssl-certificate/">Appgw ssl certificate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/cookie-affinity/">Cookie affinity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/custom-ingress-class/">Custom Ingress Class</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/multiple-namespaces/">Multiple Namespace Support</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/private-ip/">Using Private IP for internal routing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/probes/">Probes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/rewrite-rule-set-custom-resource/">Rewrite rule set custom resource</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">How tos</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/continuous-deployment/">Continuous Deployment with AKS and AGIC using Azure Pipelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/deploy-AGIC-with-Workload-Identity-using-helm/">How to deploy AGIC via Helm using Workload Identity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/dns/">Automate DNS updates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/helm-upgrade/">Upgrading AGIC using Helm</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/lets-encrypt/">Certificate issuance with LetsEncrypt.org</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/minimize-downtime-during-deployments/">Minimizing Downtime During Deployments</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/networking/">How to setup networking between Application Gateway and AKS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/prevent-agic-from-overwriting/">Preventing AGIC from removing certain rules</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/scale-applications-using-appgw-metrics/">Scale your Applications using Application Gateway Metrics (Beta)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/websockets/">Websockets</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequrently Asked Questions: [WIP]</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Troubleshootings</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/">Troubleshooting Guide</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-addon-identity-not-found/">Troubleshooting agic addon identity not found</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-fails-with-aad-pod-identity-breakingchange/">Troubleshooting agic fails with aad pod identity breakingchange</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-pod-stuck-in-not-ready-state/">Troubleshooting agic pod stuck in not ready state</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-installing-a-simple-application/">Troubleshooting installing a simple application</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../logging-levels/">Logging Levels</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Developers</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../build/">Building the controller</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../contribute/">Contribution Guidelines</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Application Gateway Ingress Controller Design (WIP)</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#document-purpose">Document Purpose</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#high-level-architecture">High-level architecture</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#components">Components</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-k8s-context-and-informers">1. K8s Context and Informers</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-worker">2. Worker</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-application-gateway-config-builder">3. Application Gateway Config Builder</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../developer-guideline/">Application Gateway Ingress Controller Development Guide</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../nightly/">Install the latest nightly build</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../test/">Testing the controller</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Application Gateway Ingress Controller</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Developers &raquo;</li>
        
      
    
    <li>Application Gateway Ingress Controller Design (WIP)</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/edit/master/docs/developers/design.md"> Edit on Azure/application-gateway-kubernetes-ingress</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="application-gateway-ingress-controller-design-wip">Application Gateway Ingress Controller Design (WIP)</h1>
<h2 id="document-purpose">Document Purpose</h2>
<p>This document is the detailed design and architecture of the Application Gateway Ingress Controller (AGIC) being built in this repository.</p>
<h2 id="overview">Overview</h2>
<p>Application Gateway Ingress Controller (AGIC) is a Kubernetes application, which makes it possible for <a href="https://azure.microsoft.com/en-us/services/kubernetes-service/">Azure Kubernetes Service (AKS)</a> customers to leverage Azure's native <a href="https://azure.microsoft.com/en-us/services/application-gateway/">Application Gateway</a> L7 load-balancer to expose cloud software to the Internet. AGIC monitors the Kubernetes cluster it is hosted on and continuously updates an App Gateway, so that selected services are exposed to the Internet.</p>
<p>The Ingress Controller runs in its own pod on the customer’s AKS. AGIC monitors a subset of Kubernetes Resources for changes. The state of the AKS cluster is translated to App Gateway  specific configuration and applied to the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview">Azure Resource Manager (ARM)</a>.</p>
<p><img alt="Azure Application Gateway + AKS" src="../../images/architecture.png" /></p>
<h2 id="high-level-architecture">High-level architecture</h2>
<p>The AGIC is composed of the following three sub components:</p>
<ol>
<li><a href="#1-k8s-context-and-informers">K8S Context and Informers</a> - handles events from the cluster and alerts the worker</li>
<li><a href="#2-worker">Worker</a> - handles events coming from the informer and perform relevant actions</li>
<li><a href="#3-application-gateway-config-builder">Application Gateway Config Builder</a> -  generates the new gateway configuration</li>
</ol>
<p><img alt="components relationship" src="../../images/component-diagram.png" /></p>
<h2 id="components">Components</h2>
<p>Let's take a look at each component:</p>
<h3 id="1-k8s-context-and-informers">1. K8s Context and Informers</h3>
<p>When any change is applied on the k8s cluster by the user, AGIC needs to listen to these changes in order to update the corresponding configuration on the Application Gateway.
We use the kubernetes informers for this purpose which is a standard for watching resources on the K8S API server.</p>
<p>When AGIC starts, it <a href="../pkg/k8scontext/context.go">sets up informers</a> for watching following resources:</p>
<ol>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a>: This is the top-level resource that AGIC monitors. It provides information about the layer-7 routing rules that need to be configured on the App Gateway.</li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/service/">Service</a>: Service provides an abstraction over the pods to expose as a network service. AGIC uses the service as logical grouping of pods to extract the IP addresses through the endpoints object created automatically along with the Service.</li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/endpoint-slices/">Endpoints</a>: Endpoints provides information about Pod IP Addresses behind a service and is used to populate AppGW's backend pool.</li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/">Pod</a>: Pod provides information about liveness and readiness probes which translated to health probe in App Gateway. AGIC only supports HTTP based liveness and readiness probe.</li>
<li><a href="https://kubernetes.io/docs/concepts/configuration/secret/">Secret</a>: This resource is for extracting SSL certificates when referenced in an ingress. This also triggeres a change when the secret is updated.</li>
<li><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRDs</a>: AGIC has some custom resources for supporting specific features like prohibited target for sharing a gateway.</li>
</ol>
<p>When starting the informers, AGIC also provides event handlers for each for create/update/delete operations on the resource. This handler is responsible for enqueuing an event .</p>
<h3 id="2-worker">2. Worker</h3>
<p><a href="../../pkg/worker.go">Worker</a> is responsible for processing the events and performing updates.</p>
<p>When Worker's <code>Run</code> function is called, it starts as a separate thread and waits on the <code>Work</code> channel. When an informers add an event to the channel, worker dequeues the event and checks whether the event is noise or is relevant. Events that are coming from unwatched namespaces and unreferenced pods/endpoints are skipped to reduce the churn. If the the last worker loop was run less than 1 second ago, it sleeps for the remainder and wakes up to space out the updates.<br />
After this, worker starts draining the rest of the events and calling the <code>ProcessEvent</code> function to process the event.</p>
<p><code>ProcessEvent</code> function does the following:</p>
<ol>
<li>Check if the Application Gateway is in <code>Running</code> or <code>Starting</code> operational state.</li>
<li>Updates all ingress resources with public/private IP address of the App Gateway.</li>
<li>Generate new config and update the Application Gateway.</li>
</ol>
<h3 id="3-application-gateway-config-builder">3. Application Gateway Config Builder</h3>
<p>This <a href="../../pkg/appgw/configbuilder.go">component</a> is responsible for using the information in the local kubernetes cache and generating the corresponding Application Gateway configuration as an output.</p>
<p>Worker invokes the <code>Build</code> on this component which then generates various gateways sub-resources starting from leaf sub-resources like <code>probes</code>, <code>http settings</code> up to the <code>request routing rules</code>.</p>
<p><code>go
func (c *appGwConfigBuilder) Build(cbCtx *ConfigBuilderContext) (*n.ApplicationGateway, error) {
...
  err := c.HealthProbesCollection(cbCtx)
...
  err = c.BackendHTTPSettingsCollection(cbCtx)
...
  err = c.BackendAddressPools(cbCtx)
...
  // generates SSL certificate, frontend ports and http listeners
  err = c.Listeners(cbCtx)
...
  // generates URL path maps and request routing rules
  err = c.RequestRoutingRules(cbCtx)
...
  return &amp;c.appGw, nil
}</code></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../developer-guideline/" class="btn btn-neutral float-right" title="Application Gateway Ingress Controller Development Guide">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../contribute/" class="btn btn-neutral" title="Contribution Guidelines"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../contribute/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../developer-guideline/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
