{{- if required "A valid appgw entry is required!" .Values.appgw }}
{{- end }}

{{- if not .Values.appgw.applicationGatewayID }}
  {{- if not .Values.appgw.name }}
    {{- if required "Please either provide appgw.applicationGatewayID or appgw.name" .Values.appgw.applicationGatewayID }}
    {{- end }}
  {{- end }}
{{- end }}

{{- if .Values.appgw.name }}
  {{- if not .Values.appgw.subnetPrefix }}
  {{- if not .Values.appgw.subnetID }}
    {{- if required "Please provide appgw.subnetPrefix or appgw.subnetID of an existing subnet" .Values.appgw.subnetPrefix }}
    {{- end }}
  {{- end }}
  {{- end }}
{{- end }}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "application-gateway-kubernetes-ingress.configmapname" . }}
  labels:
    app: {{ template "application-gateway-kubernetes-ingress.name" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
data:
  APPGW_VERBOSITY_LEVEL: {{ .Values.verbosityLevel | quote }}
  HTTP_SERVICE_PORT:     {{ .Values.kubernetes.httpServicePort | quote }}
  USE_PRIVATE_IP:        {{ .Values.appgw.usePrivateIP | quote }}

{{- if .Values.appgw.applicationGatewayID }}
  APPGW_RESOURCE_ID: {{ .Values.appgw.applicationGatewayID | quote }}
{{- else }}
  APPGW_SUBSCRIPTION_ID: {{ .Values.appgw.subscriptionId | quote }}
  APPGW_RESOURCE_GROUP:  {{ .Values.appgw.resourceGroup | quote }}
  APPGW_NAME:            {{ .Values.appgw.name | quote }}
  APPGW_ENABLE_DEPLOY:   "true"

  {{- if .Values.appgw.subnetID }}
  APPGW_SUBNET_ID: {{ .Values.appgw.subnetID | quote }}
  {{- else }}
  {{- if .Values.appgw.subnetName }}
  APPGW_SUBNET_NAME: {{ .Values.appgw.subnetName | quote }}
  {{- else }}
  APPGW_SUBNET_NAME: "{{ .Values.appgw.name }}-subnet"
  {{- end }}
  APPGW_SUBNET_PREFIX: {{ .Values.appgw.subnetPrefix | quote }} 
  {{- end }}

{{- end }}

{{- if .Values.appgw.shared }}
  APPGW_ENABLE_SHARED_APPGW: {{ .Values.appgw.shared | quote }}
{{- end }}

{{- if .Values.kubernetes.watchNamespace }}
  KUBERNETES_WATCHNAMESPACE: "{{ .Values.kubernetes.watchNamespace }}"
{{- end }}

{{- if .Values.armAuth -}}
{{- if eq .Values.armAuth.type "aadPodIdentity"}}
  USE_MANAGED_IDENTITY_FOR_POD: "true"
{{- end }}
{{- end }}