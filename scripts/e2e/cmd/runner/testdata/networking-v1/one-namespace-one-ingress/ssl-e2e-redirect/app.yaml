apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-cm
data:
  default.conf: |-
    server {
        listen 80 default_server;
        listen 443 ssl;
        root /usr/share/nginx/html;
        index index.html;
        ssl_certificate /etc/nginx/ssl/tls.crt;
        ssl_certificate_key /etc/nginx/ssl/tls.key;
        location / {
                try_files $uri $uri/ =404;
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ssl-redirect-deployment
spec:
  selector:
    matchLabels:
      app: ssl-redirect
  replicas: 2
  template:
    metadata:
      labels:
        app: ssl-redirect
    spec:
      containers:
        - name: nginx
          imagePullPolicy: Always
          image: nginx:latest
          ports:
            - containerPort: 443
          volumeMounts:
            - mountPath: /etc/nginx/ssl
              name: secret-volume
            - mountPath: /etc/nginx/conf.d
              name: configmap-volume
      volumes:
        - name: secret-volume
          secret:
            secretName: testsecret-tls
        - name: configmap-volume
          configMap:
            name: nginx-cm
---
apiVersion: v1
kind: Service
metadata:
  name: ssl-redirect-service
spec:
  selector:
    app: ssl-redirect
  ports:
    - name: https
      protocol: TCP
      port: 443
      targetPort: 443
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ssl-redirect-ingress
  annotations:
    appgw.ingress.kubernetes.io/ssl-redirect: "true"
    appgw.ingress.kubernetes.io/backend-hostname: "test"
    appgw.ingress.kubernetes.io/backend-protocol: "https"
    appgw.ingress.kubernetes.io/appgw-trusted-root-certificate: "test"
    appgw.ingress.kubernetes.io/waf-policy-for-path: "/subscriptions/db308457-7e8c-44cc-a8a7-c6d7daee414d/resourceGroups/seanjeffrey-bug-planet/providers/Microsoft.Network/applicationGatewayWebApplicationFirewallPolicies/WAF-POLICY"
spec:
  ingressClassName: azure-application-gateway
  tls:
    - secretName: testsecret-tls
  rules:
    - http:
        paths:
          - path: /index.html
            backend:
              service:
                name: ssl-redirect-service
                port:
                  name: https
            pathType: Exact
          - path: /*
            backend:
              service:
                name: ssl-redirect-service
                port:
                  name: https
            pathType: Prefix
---
apiVersion: v1
kind: Secret
metadata:
  name: testsecret-tls
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJHRENCdndJVUtQeGFwSVBRV09Ob0FqSzE3SmFjeWtCNjgxMHdDZ1lJS29aSXpqMEVBd0l3RHpFTk1Bc0cKQTFVRUF3d0VkR1Z6ZERBZUZ3MHlOVEEwTURreE1qUTRNemRhRncwME5ERXlNalV4TWpRNE16ZGFNQTh4RFRBTApCZ05WQkFNTUJIUmxjM1F3V1RBVEJnY3Foa2pPUFFJQkJnZ3Foa2pPUFFNQkJ3TkNBQVNtc2FsbCtNN0VmdmxBCjNwZGkzdXRTa3JaYnk3Vm1aWjdjbFdEK3dpclJocjNiUEpxbjNPRkRMRjViK1lTWTl5bUVGM1BLWG5wRUNiMzcKajh2NzYvczhNQW9HQ0NxR1NNNDlCQU1DQTBnQU1FVUNJQlp3OFJHUnZ6OVkrdVJVWFMzb3NER0oxaDNuRm5CcAo3SWtqSEV4bmIvOGNBaUVBL0VmaisxRm5oZ0JTaDBrTGVwc1ozZlpUSGVQcVJ3Z1ZjYWFpOTNNRnU1RT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBFQyBQQVJBTUVURVJTLS0tLS0KQmdncWhrak9QUU1CQnc9PQotLS0tLUVORCBFQyBQQVJBTUVURVJTLS0tLS0KLS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSUtXTDEzOGN6WG5qUkN0MDJibVA3b0JnVm1kTDBkTEx0dHAzOXVlcHl5NzZvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFcHJHcFpmak94SDc1UU42WFl0N3JVcEsyVzh1MVptV2UzSlZnL3NJcTBZYTkyenlhcDl6aApReXhlVy9tRW1QY3BoQmR6eWw1NlJBbTkrNC9MKyt2N1BBPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
