<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Annotations - Application Gateway Ingress Controller</title>
  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../docs/css/extra.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Annotations";
    var mkdocs_page_input_path = "annotations.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Application Gateway Ingress Controller</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Annotations</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#introductions">Introductions</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#list-of-supported-annotations">List of supported annotations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#override-frontend-port">Override Frontend Port</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#backend-path-prefix">Backend Path Prefix</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_1">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_1">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#backend-hostname">Backend Hostname</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_2">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_2">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#backend-protocol">Backend Protocol</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_3">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_3">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ssl-redirect">SSL Redirect</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_4">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_4">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#appgw-ssl-certificate">AppGw SSL Certificate</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#use-azure-cli-to-install-certificate-to-application-gateway">Use Azure CLI to install certificate to Application Gateway</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage_5">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_5">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#appgw-trusted-root-certificate">AppGW Trusted Root Certificate</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#use-azure-cli-to-install-your-root-certificate-to-application-gateway">Use Azure CLI to install your root certificate to Application Gateway</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage_6">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_6">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#appgw-ssl-profile">AppGw Ssl Profile</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#connection-draining">Connection Draining</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_7">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_7">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cookie-based-affinity">Cookie Based Affinity</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_8">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_8">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#distinct-cookie-name">Distinct cookie name</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_9">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_9">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#request-timeout">Request Timeout</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_10">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_10">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#use-private-ip">Use Private IP</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_11">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_11">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#azure-waf-policy-for-path">Azure Waf Policy For Path</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_12">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_12">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#health-probe-hostname">Health Probe Hostname</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_13">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_13">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#health-probe-port">Health Probe Port</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_14">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_14">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#health-probe-path">Health Probe Path</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_15">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_15">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#health-probe-status-codes">Health Probe Status Codes</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_16">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_16">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#health-probe-interval">Health Probe Interval</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_17">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_17">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#health-probe-timeout">Health Probe Timeout</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_18">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_18">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#health-probe-unhealthy-threshold">Health Probe Unhealthy Threshold</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_19">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_19">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rewrite-rule-set">Rewrite Rule Set</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_20">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_20">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rewrite-rule-set-custom-resource">Rewrite Rule Set Custom Resource</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_21">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_21">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#hostname-extension">Hostname Extension</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage_22">Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example_22">Example</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../helm-values-documenation/">Helm Values Configuration Options</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../ingress-v1/">Ingress V1 Support</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../setup/install/">Install</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial.e2e-ssl/">Tutorial: Setting up E2E SSL</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial.general/">Tutorial: Basic</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Features</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../features/agic-reconcile/">Agic reconcile</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/appgw-ssl-certificate/">Appgw ssl certificate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/cookie-affinity/">Cookie affinity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/custom-ingress-class/">Custom Ingress Class</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/multiple-namespaces/">Multiple Namespace Support</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/private-ip/">Using Private IP for internal routing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/probes/">Probes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/rewrite-rule-set-custom-resource/">Rewrite rule set custom resource</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">How tos</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/continuous-deployment/">Continuous Deployment with AKS and AGIC using Azure Pipelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/deploy-AGIC-with-Workload-Identity-using-helm/">How to deploy AGIC via Helm using Workload Identity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/dns/">Automate DNS updates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/helm-upgrade/">Upgrading AGIC using Helm</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/lets-encrypt/">Certificate issuance with LetsEncrypt.org</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/minimize-downtime-during-deployments/">Minimizing Downtime During Deployments</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/networking/">How to setup networking between Application Gateway and AKS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/prevent-agic-from-overwriting/">Preventing AGIC from removing certain rules</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/scale-applications-using-appgw-metrics/">Scale your Applications using Application Gateway Metrics (Beta)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/websockets/">Websockets</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../faq/">Frequrently Asked Questions: [WIP]</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Troubleshootings</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../troubleshootings/">Troubleshooting Guide</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../troubleshootings/troubleshooting-agic-addon-identity-not-found/">Troubleshooting agic addon identity not found</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../troubleshootings/troubleshooting-agic-fails-with-aad-pod-identity-breakingchange/">Troubleshooting agic fails with aad pod identity breakingchange</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../troubleshootings/troubleshooting-agic-pod-stuck-in-not-ready-state/">Troubleshooting agic pod stuck in not ready state</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../troubleshootings/troubleshooting-installing-a-simple-application/">Troubleshooting installing a simple application</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../logging-levels/">Logging Levels</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Developers</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../developers/build/">Building the controller</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../developers/contribute/">Contribution Guidelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../developers/design/">Application Gateway Ingress Controller Design (WIP)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../developers/developer-guideline/">Application Gateway Ingress Controller Development Guide</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../developers/nightly/">Install the latest nightly build</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../developers/test/">Testing the controller</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Application Gateway Ingress Controller</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Annotations</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/edit/master/docs/annotations.md"> Edit on Azure/application-gateway-kubernetes-ingress</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="annotations">Annotations</h1>
<blockquote>
<p><strong><em>NOTE:</em></strong> <a href="https://aka.ms/agc">Application Gateway for Containers</a> has been released, which introduces numerous performance, resilience, and feature changes. Please consider leveraging Application Gateway for Containers for your next deployment. A list of corresponding translations from AGIC to Application Gateway for Containers may be found <a href="https://learn.microsoft.com/azure/application-gateway/for-containers/migrate-from-agic-to-agc">here</a>.</p>
</blockquote>
<h2 id="introductions">Introductions</h2>
<p>The Kubernetes Ingress resource can be annotated with arbitrary key/value pairs. AGIC relies on annotations to program Application Gateway features, which are not configurable via the Ingress YAML. Ingress annotations are applied to all HTTP setting, backend pools and listeners derived from an ingress resource.</p>
<h2 id="list-of-supported-annotations">List of supported annotations</h2>
<p>For an Ingress resource to be observed by AGIC it <strong>must be annotated</strong> with <code>kubernetes.io/ingress.class: azure/application-gateway</code>. Only then AGIC will work with the Ingress resource in question.</p>
<table>
<thead>
<tr>
<th>Annotation Key</th>
<th>Value Type</th>
<th>Default Value</th>
<th>Allowed Values</th>
<th>Supported since</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#backend-path-prefix">appgw.ingress.kubernetes.io/backend-path-prefix</a></td>
<td><code>string</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.3.0</code></td>
</tr>
<tr>
<td><a href="#backend-hostname">appgw.ingress.kubernetes.io/backend-hostname</a></td>
<td><code>string</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.2.0</code></td>
</tr>
<tr>
<td><a href="#backend-protocol">appgw.ingress.kubernetes.io/backend-protocol</a></td>
<td><code>string</code></td>
<td><code>http</code></td>
<td><code>http</code>, <code>https</code></td>
<td><code>1.0.0</code></td>
</tr>
<tr>
<td><a href="#ssl-redirect">appgw.ingress.kubernetes.io/ssl-redirect</a></td>
<td><code>bool</code></td>
<td><code>false</code></td>
<td></td>
<td><code>1.0.0</code></td>
</tr>
<tr>
<td><a href="#appgw-ssl-certificate">appgw.ingress.kubernetes.io/appgw-ssl-certificate</a></td>
<td><code>string</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.2.0</code></td>
</tr>
<tr>
<td><a href="#appgw-trusted-root-certificate">appgw.ingress.kubernetes.io/appgw-trusted-root-certificate</a></td>
<td><code>string</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.2.0</code></td>
</tr>
<tr>
<td><a href="#appgw-ssl-profile">appgw.ingress.kubernetes.io/appgw-ssl-profile</a></td>
<td><code>string</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.6.0-rc1</code></td>
</tr>
<tr>
<td><a href="#connection-draining">appgw.ingress.kubernetes.io/connection-draining</a></td>
<td><code>bool</code></td>
<td><code>false</code></td>
<td></td>
<td><code>1.0.0</code></td>
</tr>
<tr>
<td><a href="#connection-draining">appgw.ingress.kubernetes.io/connection-draining-timeout</a></td>
<td><code>int32</code> (seconds)</td>
<td><code>30</code></td>
<td></td>
<td><code>1.0.0</code></td>
</tr>
<tr>
<td><a href="#cookie-based-affinity">appgw.ingress.kubernetes.io/cookie-based-affinity</a></td>
<td><code>bool</code></td>
<td><code>false</code></td>
<td></td>
<td><code>1.0.0</code></td>
</tr>
<tr>
<td><a href="#request-timeout">appgw.ingress.kubernetes.io/request-timeout</a></td>
<td><code>int32</code> (seconds)</td>
<td><code>30</code></td>
<td></td>
<td><code>1.0.0</code></td>
</tr>
<tr>
<td><a href="#override-frontend-port">appgw.ingress.kubernetes.io/override-frontend-port</a></td>
<td><code>string</code></td>
<td></td>
<td></td>
<td><code>1.3.0</code></td>
</tr>
<tr>
<td><a href="#use-private-ip">appgw.ingress.kubernetes.io/use-private-ip</a></td>
<td><code>bool</code></td>
<td><code>false</code></td>
<td></td>
<td><code>1.0.0</code></td>
</tr>
<tr>
<td><a href="#azure-waf-policy-for-path">appgw.ingress.kubernetes.io/waf-policy-for-path</a></td>
<td><code>string</code></td>
<td></td>
<td></td>
<td><code>1.3.0</code></td>
</tr>
<tr>
<td><a href="#health-probe-hostname">appgw.ingress.kubernetes.io/health-probe-hostname</a></td>
<td><code>string</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.4.0-rc1</code></td>
</tr>
<tr>
<td><a href="#health-probe-port">appgw.ingress.kubernetes.io/health-probe-port</a></td>
<td><code>int32</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.4.0-rc1</code></td>
</tr>
<tr>
<td><a href="#health-probe-path">appgw.ingress.kubernetes.io/health-probe-path</a></td>
<td><code>string</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.4.0-rc1</code></td>
</tr>
<tr>
<td><a href="#health-probe-status-codes">appgw.ingress.kubernetes.io/health-probe-status-codes</a></td>
<td><code>[]string</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.4.0-rc1</code></td>
</tr>
<tr>
<td><a href="#health-probe-interval">appgw.ingress.kubernetes.io/health-probe-interval</a></td>
<td><code>int32</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.4.0-rc1</code></td>
</tr>
<tr>
<td><a href="#health-probe-timeout">appgw.ingress.kubernetes.io/health-probe-timeout</a></td>
<td><code>int32</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.4.0-rc1</code></td>
</tr>
<tr>
<td><a href="#health-probe-unhealthy-threshold">appgw.ingress.kubernetes.io/health-probe-unhealthy-threshold</a></td>
<td><code>int32</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.4.0-rc1</code></td>
</tr>
<tr>
<td><a href="#rewrite-rule-set">appgw.ingress.kubernetes.io/rewrite-rule-set</a></td>
<td><code>string</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.5.0-rc1</code></td>
</tr>
<tr>
<td><a href="#rewrite-rule-set-custom-resource">appgw.ingress.kubernetes.io/rewrite-rule-set-custom-resource</a></td>
<td><code>string</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.6.0-rc1</code></td>
</tr>
<tr>
<td><a href="#hostname-extension">appgw.ingress.kubernetes.io/hostname-extension</a></td>
<td><code>string</code></td>
<td><code>nil</code></td>
<td></td>
<td><code>1.4.0</code></td>
</tr>
</tbody>
</table>
<h2 id="override-frontend-port">Override Frontend Port</h2>
<p>The annotation allows to configure frontend listener to use different ports other than 80/443 for http/https.</p>
<p>If the port is within the App Gw authorized range (1 - 64999), this listener will be created on this specific port. If an invalid port or no port is set in the annotation, the configuration will fallback on default 80 or 443.</p>
<h3 id="usage">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/override-frontend-port</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;port&quot;</span>
</code></pre></div>
<h3 id="example">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-overridefrontendport</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/override-frontend-port</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8080&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/hello/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<p>External request will need to target <a href="http://somehost:8080">http://somehost:8080</a> instead of <a href="http://somehost">http://somehost</a>.</p>
<h2 id="backend-path-prefix">Backend Path Prefix</h2>
<p>This annotation allows the backend path specified in an ingress resource to be re-written with prefix specified in this annotation. This allows users to expose services whose endpoints are different than endpoint names used to expose a service in an ingress resource.</p>
<h3 id="usage_1">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/backend-path-prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;path prefix&gt;</span>
</code></pre></div>
<h3 id="example_1">Example</h3>
<p><div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-bkprefix</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/backend-path-prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/test/&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/hello/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
In the example above we have defined an ingress resource named <code>go-server-ingress-bkprefix</code> with an annotation <code>appgw.ingress.kubernetes.io/backend-path-prefix: "/test/"</code> . The annotation tells application gateway to create an HTTP setting which will have a path prefix override for the path <code>/hello</code> to <code>/test/</code>.</p>
<p><strong><em>NOTE:</em></strong> In the above example we have only one rule defined. However, the annotations is applicable to the entire ingress resource so if a user had defined multiple rules the backend path prefix would be setup for each of the paths specified. Thus, if a user wants different rules with different path prefixes (even for the same service) they would need to define different ingress resources.</p>
<p>If your incoming path is /hello/test/health but your backend requires /health you will want to ensure you have /* on your path</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-bkprefix</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/backend-path-prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/hello/test/*</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
</code></pre></div>
<h2 id="backend-hostname">Backend Hostname</h2>
<p>This annotations allows us to specify the host name that Application Gateway should use while talking to the Pods.</p>
<h3 id="usage_2">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/backend-hostname</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;internal.example.com&quot;</span>
</code></pre></div>
<h3 id="example_2">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-timeout</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/backend-hostname</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;internal.example.com&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/hello/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="backend-protocol">Backend Protocol</h2>
<p>This annotation allows us to specify the protocol that Application Gateway should use while talking to the Pods. Supported Protocols: <code>http</code>, <code>https</code></p>
<blockquote>
<p><strong>Note</strong>
1) Make sure to not use port 80 with HTTPS and port 443 with HTTP on the Pods.</p>
</blockquote>
<h3 id="usage_3">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https&quot;</span>
</code></pre></div>
<h3 id="example_3">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-timeout</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/hello/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="ssl-redirect">SSL Redirect</h2>
<p>Application Gateway <a href="https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-redirect-overview">can be configured</a>
to automatically redirect HTTP URLs to their HTTPS counterparts. When this
annotation is present and TLS is properly configured, Kubernetes Ingress
controller will create a <a href="https://docs.microsoft.com/en-us/azure/application-gateway/redirect-http-to-https-portal#add-a-routing-rule-with-a-redirection-configuration">routing rule with a redirection configuration</a>
and apply the changes to your App Gateway. The redirect created will be HTTP <code>301 Moved Permanently</code>.</p>
<h3 id="usage_4">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/ssl-redirect</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</code></pre></div>
<h3 id="example_4">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-redirect</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/ssl-redirect</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">     </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.contoso.com</span>
<span class="w">     </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testsecret-tls</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.contoso.com</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">websocket-repeater</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<h2 id="appgw-ssl-certificate">AppGw SSL Certificate</h2>
<p>The SSL certificate <a href="https://docs.microsoft.com/en-us/cli/azure/network/application-gateway/ssl-cert?view=azure-cli-latest#az-network-application-gateway-ssl-cert-create">can be configured to Application Gateway</a> either from a local PFX certificate file or a reference to a Azure Key Vault unversioned secret Id.
When the annotation is present with a certificate name and the certificate is pre-installed in Application Gateway, Kubernetes Ingress controller will create a routing rule with a HTTPS listener and apply the changes to your App Gateway.
<code>appgw-ssl-certificate</code> annotation can also be used together with <code>ssl-redirect</code> annotation in case of SSL redirect.</p>
<p>Please refer to <a href="../features/appgw-ssl-certificate/">appgw-ssl-certificate feature</a> for more details.</p>
<blockquote>
<p><strong>Note</strong>
* Annotation "appgw-ssl-certificate" will be ignored when TLS Spec is defined in ingress at the same time.
* If a user wants different certs with different hosts(multi tls certificate termination), they would need to define different ingress resources.</p>
</blockquote>
<h3 id="use-azure-cli-to-install-certificate-to-application-gateway">Use Azure CLI to install certificate to Application Gateway</h3>
<ul>
<li>
<p>Configure from a local PFX certificate file
<div class="highlight"><pre><span></span><code>az<span class="w"> </span>network<span class="w"> </span>application-gateway<span class="w"> </span>ssl-cert<span class="w"> </span>create<span class="w"> </span>-g<span class="w"> </span><span class="nv">$resgp</span><span class="w">  </span>--gateway-name<span class="w"> </span><span class="nv">$appgwName</span><span class="w"> </span>-n<span class="w"> </span>mysslcert<span class="w"> </span>--cert-file<span class="w"> </span><span class="se">\p</span>ath<span class="se">\t</span>o<span class="se">\c</span>ert<span class="se">\f</span>ile<span class="w"> </span>--cert-password<span class="w"> </span>Abc123
</code></pre></div></p>
</li>
<li>
<p>Configure from a reference to a Key Vault unversioned secret id
<div class="highlight"><pre><span></span><code>az<span class="w"> </span>keyvault<span class="w"> </span>certificate<span class="w"> </span>create<span class="w"> </span>--vault-name<span class="w"> </span><span class="nv">$vaultName</span><span class="w"> </span>-n<span class="w"> </span>cert1<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>az<span class="w"> </span>keyvault<span class="w"> </span>certificate<span class="w"> </span>get-default-policy<span class="k">)</span><span class="s2">&quot;</span>
<span class="nv">versionedSecretId</span><span class="o">=</span><span class="k">$(</span>az<span class="w"> </span>keyvault<span class="w"> </span>certificate<span class="w"> </span>show<span class="w"> </span>-n<span class="w"> </span>cert<span class="w"> </span>--vault-name<span class="w"> </span><span class="nv">$vaultName</span><span class="w"> </span>--query<span class="w"> </span><span class="s2">&quot;sid&quot;</span><span class="w"> </span>-o<span class="w"> </span>tsv<span class="k">)</span>
<span class="nv">unversionedSecretId</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$versionedSecretId</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39;/&#39;</span><span class="w"> </span>-f-5<span class="k">)</span><span class="w"> </span><span class="c1"># remove the version from the url</span>
az<span class="w"> </span>network<span class="w"> </span>application-gateway<span class="w"> </span>ssl-cert<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>mysslcert<span class="w"> </span>--gateway-name<span class="w"> </span><span class="nv">$appgwName</span><span class="w"> </span>--resource-group<span class="w"> </span><span class="nv">$resgp</span><span class="w"> </span>--key-vault-secret-id<span class="w"> </span><span class="nv">$unversionedSecretId</span>
</code></pre></div></p>
</li>
</ul>
<p>To use PowerShell, please refer to <a href="https://docs.microsoft.com/en-us/azure/application-gateway/configure-keyvault-ps">Configure Key Vault - PowerShell</a>.</p>
<h3 id="usage_5">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/appgw-ssl-certificate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;name-of-appgw-installed-certificate&quot;</span>
</code></pre></div>
<h3 id="example_5">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-certificate</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/appgw-ssl-certificate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;name-of-appgw-installed-certificate&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.contoso.com</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">websocket-repeater</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<h2 id="appgw-trusted-root-certificate">AppGW Trusted Root Certificate</h2>
<p>Users now can <a href="https://docs.microsoft.com/en-us/cli/azure/network/application-gateway/root-cert?view=azure-cli-latest">configure their own root certificates to Application Gateway</a> to be trusted via AGIC.
The annotaton <code>appgw-trusted-root-certificate</code> shall be used together with annotation <code>backend-protocol</code> to indicate end-to-end ssl encryption, multiple root certificates, separated by comma, if specified, e.g. "name-of-my-root-cert1,name-of-my-root-certificate2".</p>
<h3 id="use-azure-cli-to-install-your-root-certificate-to-application-gateway">Use Azure CLI to install your root certificate to Application Gateway</h3>
<ul>
<li>
<p>Create your public root certificate for testing
<div class="highlight"><pre><span></span><code>openssl<span class="w"> </span>ecparam<span class="w"> </span>-out<span class="w"> </span>test.key<span class="w"> </span>-name<span class="w"> </span>prime256v1<span class="w"> </span>-genkey
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-sha256<span class="w"> </span>-key<span class="w"> </span>test.key<span class="w"> </span>-out<span class="w"> </span>test.csr
openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-sha256<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-in<span class="w"> </span>test.csr<span class="w"> </span>-signkey<span class="w"> </span>test.key<span class="w"> </span>-out<span class="w"> </span>test.crt
</code></pre></div></p>
</li>
<li>
<p>Configure your root certificate to Application Gateway
<div class="highlight"><pre><span></span><code><span class="c1"># Rename test.crt to test.cer</span>
mv<span class="w"> </span>test.crt<span class="w"> </span>test.cer

<span class="c1"># Configure the root certificate to your Application Gateway</span>
az<span class="w"> </span>network<span class="w"> </span>application-gateway<span class="w"> </span>root-cert<span class="w"> </span>create<span class="w"> </span>--cert-file<span class="w"> </span>test.cer<span class="w">  </span>--gateway-name<span class="w"> </span><span class="nv">$appgwName</span><span class="w">  </span>--name<span class="w"> </span>name-of-my-root-cert1<span class="w"> </span>--resource-group<span class="w"> </span><span class="nv">$resgp</span>
</code></pre></div></p>
</li>
<li>
<p>Repeat the steps above if you want to configure multiple trusted root certificates</p>
</li>
</ul>
<h3 id="usage_6">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https&quot;</span>
<span class="nt">appgw.ingress.kubernetes.io/appgw-trusted-root-certificate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;name-of-my-root-cert1&quot;</span>
</code></pre></div>
<h3 id="example_6">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-certificate</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https&quot;</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/appgw-trusted-root-certificate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;name-of-my-root-cert1&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.contoso.com</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">websocket-repeater</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<h2 id="appgw-ssl-profile">AppGw Ssl Profile</h2>
<blockquote>
<p>Note: This annotation is supported since 1.6.0-rc1.</p>
</blockquote>
<p>Users can configure <a href="https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-configure-listener-specific-ssl-policy">a ssl profile on the Application Gateway per listener</a>.
When the annotation is present with a profile name and the profile is pre-installed in the Application Gateway, Kubernetes Ingress controller will create a routing rule with a HTTPS listener and apply the changes to your App Gateway.</p>
<h2 id="connection-draining">Connection Draining</h2>
<p><code>connection-draining</code>: This annotation allows to specify whether to enable connection draining.
<code>connection-draining-timeout</code>: This annotation allows to specify a timeout after which Application Gateway will terminate the requests to the draining backend endpoint.</p>
<h3 id="usage_7">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/connection-draining</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="nt">appgw.ingress.kubernetes.io/connection-draining-timeout</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
</code></pre></div>
<h3 id="example_7">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-drain</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/connection-draining</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/connection-draining-timeout</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/hello/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="cookie-based-affinity">Cookie Based Affinity</h2>
<p>This annotation allows to specify whether to enable cookie based affinity.</p>
<h3 id="usage_8">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/cookie-based-affinity</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</code></pre></div>
<h3 id="example_8">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-affinity</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/cookie-based-affinity</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/hello/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="distinct-cookie-name">Distinct cookie name</h2>
<p>In addition to cookie-based-affinity, you can set <code>cookie-based-affinity-distinct-name: "true"</code> to ensure a different affinity cookie is set per backend.</p>
<h3 id="usage_9">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/cookie-based-affinity-distinct-name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</code></pre></div>
<h3 id="example_9">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-affinity</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/cookie-based-affinity</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/cookie-based-affinity-distinct-name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/affinity1/</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">affinity-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/affinity2/</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">affinity-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<h2 id="request-timeout">Request Timeout</h2>
<p>This annotation allows to specify the request timeout in seconds after which Application Gateway will fail the request if response is not received.</p>
<h3 id="usage_10">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/request-timeout</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;20&quot;</span>
</code></pre></div>
<h3 id="example_10">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-timeout</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/request-timeout</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;20&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/hello/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="use-private-ip">Use Private IP</h2>
<p>This annotation allows us to specify whether to expose this endpoint on Private IP of Application Gateway.</p>
<blockquote>
<p><strong>Note</strong></p>
</blockquote>
<p>1) App Gateway doesn't support multiple IPs on the same port (example: 80/443). Ingress with annotation <code>appgw.ingress.kubernetes.io/use-private-ip: "false"</code> and another with <code>appgw.ingress.kubernetes.io/use-private-ip: "true"</code> on <code>HTTP</code> will cause AGIC to fail in updating the App Gateway.</p>
<p>2) For App Gateway that doesn't have a private IP, Ingresses with <code>appgw.ingress.kubernetes.io/use-private-ip: "true"</code> will be ignored. This will reflected in the controller logs and ingress events for those ingresses with <code>NoPrivateIP</code> warning.</p>
<h3 id="usage_11">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/use-private-ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</code></pre></div>
<h3 id="example_11">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-timeout</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/use-private-ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/hello/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="azure-waf-policy-for-path">Azure Waf Policy For Path</h2>
<p>This annotation allows you to attach an already created WAF policy to the list paths for a host within a Kubernetes
Ingress resource being annotated.</p>
<p>The WAF policy must be created in advance. Example of using <a href="https://portal.azure.com/">Azure Portal</a> to create a policy:
<img alt="Creating a WAF policy" src="../images/waf-policy.png" /></p>
<p>Once the policy is created, copy the URI of the policy from the address bar of Azure Portal:
<img alt="Creating a WAF policy" src="../images/waf-policy-1.png" /></p>
<p>The URI would have the following format:
<div class="highlight"><pre><span></span><code>/subscriptions/&lt;YOUR-SUBSCRIPTION&gt;/resourceGroups/&lt;YOUR-RESOURCE-GROUP&gt;/providers/Microsoft.Network/applicationGatewayWebApplicationFirewallPolicies/&lt;YOUR-POLICY-NAME&gt;
</code></pre></div></p>
<blockquote>
<p><strong>Note</strong>
1) Waf policy will only be applied to a listener if ingress rule path is not set or set to "/" or "/*"</p>
</blockquote>
<h3 id="usage_12">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/waf-policy-for-path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/subscriptions/abcd/resourceGroups/rg/providers/Microsoft.Network/applicationGatewayWebApplicationFirewallPolicies/adserver&quot;</span>
</code></pre></div>
<h3 id="example_12">Example</h3>
<p>The example below will apply the WAF policy
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ad-server-ingress</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">commerce</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/waf-policy-for-path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/subscriptions/abcd/resourceGroups/rg/providers/Microsoft.Network/applicationGatewayWebApplicationFirewallPolicies/adserver&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/ad-server</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ad-server</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/auth</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">auth-server</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
Note that the WAF policy will be applied to both <code>/ad-server</code> and <code>/auth</code> URLs.</p>
<h2 id="health-probe-hostname">Health Probe Hostname</h2>
<p>This annotation allows specifically define a target host to be used for AGW health probe. By default, if backend container running service with liveliness probe of type <code>HTTP GET</code> defined, host used in liveliness probe definition is also used as a target host for health probe. However if annotation <code>appgw.ingress.kubernetes.io/health-probe-hostname</code> is defined it overrides it with its own value.</p>
<h3 id="usage_13">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/health-probe-hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;hostname&gt;</span>
</code></pre></div>
<h3 id="example_13">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-bkprefix</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/health-probe-hostname</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my-backend-host.custom.app&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/hello/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="health-probe-port">Health Probe Port</h2>
<p>Health probe port annotation allows specifically define target TCP port to be used for AGW health probe. By default, if backend container running service has liveliness probe of type <code>HTTP GET</code> defined, port used in liveliness probe definition is also used as a port for health probe. Annotation <code>appgw.ingress.kubernetes.io/health-probe-port</code> has precedence over such default value.</p>
<h3 id="usage_14">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/health-probe-port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;port number&gt;</span>
</code></pre></div>
<h3 id="example_14">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-bkprefix</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/health-probe-hostname</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my-backend-host.custom.app&quot;</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/health-probe-port</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;443&quot;</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/health-probe-path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/healthz&quot;</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my-backend-host.custom.app-ssl-certificate&quot;</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="health-probe-path">Health Probe Path</h2>
<p>This annotation allows specifically define target URI path to be used for AGW health probe. By default, if backend container running service with liveliness probe of type <code>HTTP GET</code> defined , path defined in liveliness probe definition is also used as a path for health probe. However annotation <code>appgw.ingress.kubernetes.io/health-probe-path</code> overrides it with its own value.</p>
<h3 id="usage_15">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/health-probe-path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;URI path&gt;</span>
</code></pre></div>
<h3 id="example_15">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-bkprefix</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/health-probe-hostname</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my-backend-host.custom.app&quot;</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/health-probe-port</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8080&quot;</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/health-probe-path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/healthz&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</code></pre></div>
<h2 id="health-probe-status-codes">Health Probe Status Codes</h2>
<p>This annotation defines healthy status codes returned by the health probe. The values are comma separated list of individual status codes or ranges defined as <code>&lt;start of the range&gt;-&lt;end of the range&gt;</code>.</p>
<h3 id="usage_16">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/health-probe-status-codes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;status codes&gt;</span>
</code></pre></div>
<h3 id="example_16">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-bkprefix</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/health-probe-status-codes</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;200-399,</span><span class="nv"> </span><span class="s">401&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="health-probe-interval">Health Probe Interval</h2>
<p>This annotation sets AGW health probe interval. By default, if backend container running service with liveliness probe of type <code>HTTP GET</code> defined, interval in liveliness probe definition is also used as a interval for health probe. However annotation <code>appgw.ingress.kubernetes.io/health-probe-interval</code> overrides it with its value.</p>
<h3 id="usage_17">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/health-probe-interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;interval seconds&gt;</span>
</code></pre></div>
<h3 id="example_17">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-bkprefix</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/health-probe-interval</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;20&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="health-probe-timeout">Health Probe Timeout</h2>
<p>This annotation allows specifically define timeout for AGW health probe. By default, if backend container running service with liveliness probe of type <code>HTTP GET</code> defined, timeout defined in liveliness probe definition is also used for health probe. However annotation <code>appgw.ingress.kubernetes.io/health-probe-timeout</code> overrides it with its value.</p>
<h3 id="usage_18">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/health-probe-timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;timeout seconds&gt;</span>
</code></pre></div>
<h3 id="example_18">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-bkprefix</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/health-probe-timeout</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;15&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="health-probe-unhealthy-threshold">Health Probe Unhealthy Threshold</h2>
<p>This annotation allows specifically define target unhealthy thresold for AGW health probe. By default, if backend container running service with liveliness probe of type <code>HTTP GET</code> defined , threshold defined in liveliness probe definition is also used for health probe. However annotation <code>appgw.ingress.kubernetes.io/health-probe-unhealthy-threshold</code> overrides it with its value.</p>
<h3 id="usage_19">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/health-probe-unhealthy-threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;unhealthy threshold&gt;</span>
</code></pre></div>
<h3 id="example_19">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-bkprefix</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/health-probe-unhealthy-threshold</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
</code></pre></div>
<h2 id="rewrite-rule-set">Rewrite Rule Set</h2>
<p>This annotation allows to assign an existing rewrite rule set to the corresponding request routing rule(s). Rewrite rule set is managed via Azure Portal / CLI / PS.</p>
<h3 id="usage_20">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/rewrite-rule-set</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;rewrite rule set&gt;</span>
</code></pre></div>
<h3 id="example_20">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-bkprefix</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/rewrite-rule-set</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">add-custom-response-header</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</code></pre></div>
<h2 id="rewrite-rule-set-custom-resource">Rewrite Rule Set Custom Resource</h2>
<blockquote>
<p>Note: This annotation is supported since 1.6.0-rc1.</p>
</blockquote>
<p>This annotation allows to assign a header/URL rewrite rule set created via the AzureApplicationGatewayRewrite CR to be associated to all rules in an ingress resource. AzureApplicationGatewayRewrite CR should be present in the same namespace as the ingress.</p>
<h3 id="usage_21">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/rewrite-rule-set-custom-resource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;name of rewrite rule set custom resource&gt;</span>
</code></pre></div>
<h3 id="example_21">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">appgw.ingress.azure.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AzureApplicationGatewayRewrite</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-rewrite-rule-set</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rewriteRules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rule1</span>
<span class="w">    </span><span class="nt">ruleSequence</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">21</span>

<span class="w">    </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ignoreCase</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">negate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">variable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http_req_Host</span>
<span class="w">      </span><span class="nt">pattern</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example.com</span>

<span class="w">    </span><span class="nt">actions</span><span class="p">:</span>
<span class="w">      </span><span class="nt">requestHeaderConfigurations</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">actionType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">set</span>
<span class="w">        </span><span class="nt">headerName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">incoming-test-header</span>
<span class="w">        </span><span class="nt">headerValue</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">incoming-test-value</span>

<span class="w">      </span><span class="nt">responseHeaderConfigurations</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">actionType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">set</span>
<span class="w">        </span><span class="nt">headerName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">outgoing-test-header</span>
<span class="w">        </span><span class="nt">headerValue</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">outgoing-test-value</span>

<span class="w">      </span><span class="nt">urlConfiguration</span><span class="p">:</span>
<span class="w">        </span><span class="nt">modifiedPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/api/&quot;</span>
<span class="w">        </span><span class="nt">modifiedQueryString</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;query=test-value&quot;</span>
<span class="w">        </span><span class="nt">reroute</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nn">---</span>

<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go-server-ingress-bkprefix</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/rewrite-rule-set-custom-resource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-rewrite-rule-set</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</code></pre></div>
<h2 id="hostname-extension">Hostname Extension</h2>
<p>This annotation allows to append additional hostnames to the <code>host</code> specified in the ingress resource. This applies to all the rules in the ingress resource.</p>
<h3 id="usage_22">Usage</h3>
<div class="highlight"><pre><span></span><code><span class="nt">appgw.ingress.kubernetes.io/hostname-extension</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;hostname1,</span><span class="nv"> </span><span class="s">hostname2&quot;</span>
</code></pre></div>
<h3 id="example_22">Example</h3>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-app-ingress</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-ag</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="w">    </span><span class="nt">appgw.ingress.kubernetes.io/hostname-extension</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;prod-store.app.com&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;store.app.com&quot;</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exact</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">store-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</code></pre></div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../helm-values-documenation/" class="btn btn-neutral float-right" title="Helm Values Configuration Options">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Introduction"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../helm-values-documenation/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
